# Витрина расчётов с курьерами
# 1. Описание витрины
Наименование:
- dm_courier_ledger
Первичный ключ состоит из полей:
- courier_id
- settlement_year
- settlement_month
# 2. Поля витрины
- id — идентификатор записи.
- courier_id — ID курьера, которому перечисляем.
- courier_name — Ф. И. О. курьера.
- settlement_year — год отчёта.
- settlement_month — месяц отчёта, где 1 — январь и 12 — декабрь.
- orders_count — количество заказов за период (месяц).
- orders_total_sum — общая стоимость заказов.
- rate_avg — средний рейтинг курьера по оценкам пользователей.
- order_processing_fee — сумма, удержанная компанией за обработку заказов, которая высчитывается как orders_total_sum * 0.25.
- courier_order_sum — сумма, которую необходимо перечислить курьеру за доставленные им/ей заказы. За каждый доставленный заказ курьер должен получить некоторую сумму в зависимости от рейтинга (см. ниже).
- courier_tips_sum — сумма, которую пользователи оставили курьеру в качестве чаевых.
- courier_reward_sum — сумма, которую необходимо перечислить курьеру. Вычисляется как courier_order_sum + courier_tips_sum * 0.95 (5% — комиссия за обработку платежа).

Правила расчёта процента выплаты курьеру в зависимости от рейтинга, где r — это средний рейтинг курьера в расчётном месяце:
- r < 4 — 5% от заказа, но не менее 100 р.
- 4 <= r < 4.5 — 7% от заказа, но не менее 150 р.
- 4.5 <= r < 4.9 — 8% от заказа, но не менее 175 р.
- 4.9 <= r — 10% от заказа, но не менее 200 р.

# 3. Источники
- stg.api_couriers — таблица с данными о курьерах из API источника "AS IS". Таблицу необходимо создать.
Поля:
id - уникальный идентификатор курьера
name - ФИО курьера
- stg.api_deliveries — таблица с данными о доставках из API источника "AS IS". Таблицу необходимо создать
Поля:
order_id — ID заказа
order_ts — дата и время создания заказа
delivery_id — ID доставки
courier_id — ID курьера
address — адрес доставки
delivery_ts — дата и время совершения доставки
rate — рейтинг доставки, который выставляет покупатель: целочисленное значение от 1 до 5
tip_sum — сумма чаевых, которые оставил покупатель курьеру (в руб.)
sum — сумма заказа

- dds.api_orders - таблица для хранения исторических данных о заказах. Таблицу необходимо создать
Поля:
id - уникальный идентификатор записи в таблице. Первичный ключ
order_id - ID заказа

- dds.api_couriers - таблица для хранения исторических данных о курьерах. Таблицу необходимо создать
Поля:
id - уникальный идентификатор записи в таблице. Первичный ключ
courier_id - ID курьера

- dds.api_deliveries - таблица для хранения исторических данных о доставке. Таблицу необходимо создать
Поля:
id - уникальный идентификатор записи в таблице. Первичный ключ
delivery_id - ID доставки

- dds.fct_api_deliveries - таблица для хранения исторических данных с фактами доставки. Таблицу необходимо создать
Поля:
order_id — ID заказа
order_ts — дата и время создания заказа
delivery_id — ID доставки
courier_id — ID курьера
address — адрес доставки
delivery_ts — дата и время совершения доставки
rate — рейтинг доставки, который выставляет покупатель: целочисленное значение от 1 до 5
tip_sum — сумма чаевых, которые оставил покупатель курьеру (в руб.)
sum — сумма заказа